#!/bin/bash

URL="$1"
DOWNLOAD_DIR="$2"

cd "$DOWNLOAD_DIR"

# curl does not support filename*=UTF-8'' Content-Disposition
# work around it!
# for hex in {{0..9},{a..f}}{{0..9},{a..f}}; do echo "s/%$hex/\\\x$hex/gi"; done
UTF_FILENAME="$(curl -s "$URL" --compressed -b "$COOKIE_JAR" -I \
	| sed -n -r "s/^Content-Disposition:.* filename\*=UTF-8''(.*)\r$/\1/p" \
	| sed '
		s/%00/\x00/gi
		s/%01/\x01/gi
		s/%02/\x02/gi
		s/%03/\x03/gi
		s/%04/\x04/gi
		s/%05/\x05/gi
		s/%06/\x06/gi
		s/%07/\x07/gi
		s/%08/\x08/gi
		s/%09/\x09/gi
		s/%0a/\x0a/gi
		s/%0b/\x0b/gi
		s/%0c/\x0c/gi
		s/%0d/\x0d/gi
		s/%0e/\x0e/gi
		s/%0f/\x0f/gi
		s/%10/\x10/gi
		s/%11/\x11/gi
		s/%12/\x12/gi
		s/%13/\x13/gi
		s/%14/\x14/gi
		s/%15/\x15/gi
		s/%16/\x16/gi
		s/%17/\x17/gi
		s/%18/\x18/gi
		s/%19/\x19/gi
		s/%1a/\x1a/gi
		s/%1b/\x1b/gi
		s/%1c/\x1c/gi
		s/%1d/\x1d/gi
		s/%1e/\x1e/gi
		s/%1f/\x1f/gi
		s/%20/\x20/gi
		s/%21/\x21/gi
		s/%22/\x22/gi
		s/%23/\x23/gi
		s/%24/\x24/gi
		s/%25/\x25/gi
		s/%26/\x26/gi
		s/%27/\x27/gi
		s/%28/\x28/gi
		s/%29/\x29/gi
		s/%2a/\x2a/gi
		s/%2b/\x2b/gi
		s/%2c/\x2c/gi
		s/%2d/\x2d/gi
		s/%2e/\x2e/gi
		s/%2f/\x2f/gi
		s/%30/\x30/gi
		s/%31/\x31/gi
		s/%32/\x32/gi
		s/%33/\x33/gi
		s/%34/\x34/gi
		s/%35/\x35/gi
		s/%36/\x36/gi
		s/%37/\x37/gi
		s/%38/\x38/gi
		s/%39/\x39/gi
		s/%3a/\x3a/gi
		s/%3b/\x3b/gi
		s/%3c/\x3c/gi
		s/%3d/\x3d/gi
		s/%3e/\x3e/gi
		s/%3f/\x3f/gi
		s/%40/\x40/gi
		s/%41/\x41/gi
		s/%42/\x42/gi
		s/%43/\x43/gi
		s/%44/\x44/gi
		s/%45/\x45/gi
		s/%46/\x46/gi
		s/%47/\x47/gi
		s/%48/\x48/gi
		s/%49/\x49/gi
		s/%4a/\x4a/gi
		s/%4b/\x4b/gi
		s/%4c/\x4c/gi
		s/%4d/\x4d/gi
		s/%4e/\x4e/gi
		s/%4f/\x4f/gi
		s/%50/\x50/gi
		s/%51/\x51/gi
		s/%52/\x52/gi
		s/%53/\x53/gi
		s/%54/\x54/gi
		s/%55/\x55/gi
		s/%56/\x56/gi
		s/%57/\x57/gi
		s/%58/\x58/gi
		s/%59/\x59/gi
		s/%5a/\x5a/gi
		s/%5b/\x5b/gi
		s/%5c/\x5c/gi
		s/%5d/\x5d/gi
		s/%5e/\x5e/gi
		s/%5f/\x5f/gi
		s/%60/\x60/gi
		s/%61/\x61/gi
		s/%62/\x62/gi
		s/%63/\x63/gi
		s/%64/\x64/gi
		s/%65/\x65/gi
		s/%66/\x66/gi
		s/%67/\x67/gi
		s/%68/\x68/gi
		s/%69/\x69/gi
		s/%6a/\x6a/gi
		s/%6b/\x6b/gi
		s/%6c/\x6c/gi
		s/%6d/\x6d/gi
		s/%6e/\x6e/gi
		s/%6f/\x6f/gi
		s/%70/\x70/gi
		s/%71/\x71/gi
		s/%72/\x72/gi
		s/%73/\x73/gi
		s/%74/\x74/gi
		s/%75/\x75/gi
		s/%76/\x76/gi
		s/%77/\x77/gi
		s/%78/\x78/gi
		s/%79/\x79/gi
		s/%7a/\x7a/gi
		s/%7b/\x7b/gi
		s/%7c/\x7c/gi
		s/%7d/\x7d/gi
		s/%7e/\x7e/gi
		s/%7f/\x7f/gi
		s/%80/\x80/gi
		s/%81/\x81/gi
		s/%82/\x82/gi
		s/%83/\x83/gi
		s/%84/\x84/gi
		s/%85/\x85/gi
		s/%86/\x86/gi
		s/%87/\x87/gi
		s/%88/\x88/gi
		s/%89/\x89/gi
		s/%8a/\x8a/gi
		s/%8b/\x8b/gi
		s/%8c/\x8c/gi
		s/%8d/\x8d/gi
		s/%8e/\x8e/gi
		s/%8f/\x8f/gi
		s/%90/\x90/gi
		s/%91/\x91/gi
		s/%92/\x92/gi
		s/%93/\x93/gi
		s/%94/\x94/gi
		s/%95/\x95/gi
		s/%96/\x96/gi
		s/%97/\x97/gi
		s/%98/\x98/gi
		s/%99/\x99/gi
		s/%9a/\x9a/gi
		s/%9b/\x9b/gi
		s/%9c/\x9c/gi
		s/%9d/\x9d/gi
		s/%9e/\x9e/gi
		s/%9f/\x9f/gi
		s/%a0/\xa0/gi
		s/%a1/\xa1/gi
		s/%a2/\xa2/gi
		s/%a3/\xa3/gi
		s/%a4/\xa4/gi
		s/%a5/\xa5/gi
		s/%a6/\xa6/gi
		s/%a7/\xa7/gi
		s/%a8/\xa8/gi
		s/%a9/\xa9/gi
		s/%aa/\xaa/gi
		s/%ab/\xab/gi
		s/%ac/\xac/gi
		s/%ad/\xad/gi
		s/%ae/\xae/gi
		s/%af/\xaf/gi
		s/%b0/\xb0/gi
		s/%b1/\xb1/gi
		s/%b2/\xb2/gi
		s/%b3/\xb3/gi
		s/%b4/\xb4/gi
		s/%b5/\xb5/gi
		s/%b6/\xb6/gi
		s/%b7/\xb7/gi
		s/%b8/\xb8/gi
		s/%b9/\xb9/gi
		s/%ba/\xba/gi
		s/%bb/\xbb/gi
		s/%bc/\xbc/gi
		s/%bd/\xbd/gi
		s/%be/\xbe/gi
		s/%bf/\xbf/gi
		s/%c0/\xc0/gi
		s/%c1/\xc1/gi
		s/%c2/\xc2/gi
		s/%c3/\xc3/gi
		s/%c4/\xc4/gi
		s/%c5/\xc5/gi
		s/%c6/\xc6/gi
		s/%c7/\xc7/gi
		s/%c8/\xc8/gi
		s/%c9/\xc9/gi
		s/%ca/\xca/gi
		s/%cb/\xcb/gi
		s/%cc/\xcc/gi
		s/%cd/\xcd/gi
		s/%ce/\xce/gi
		s/%cf/\xcf/gi
		s/%d0/\xd0/gi
		s/%d1/\xd1/gi
		s/%d2/\xd2/gi
		s/%d3/\xd3/gi
		s/%d4/\xd4/gi
		s/%d5/\xd5/gi
		s/%d6/\xd6/gi
		s/%d7/\xd7/gi
		s/%d8/\xd8/gi
		s/%d9/\xd9/gi
		s/%da/\xda/gi
		s/%db/\xdb/gi
		s/%dc/\xdc/gi
		s/%dd/\xdd/gi
		s/%de/\xde/gi
		s/%df/\xdf/gi
		s/%e0/\xe0/gi
		s/%e1/\xe1/gi
		s/%e2/\xe2/gi
		s/%e3/\xe3/gi
		s/%e4/\xe4/gi
		s/%e5/\xe5/gi
		s/%e6/\xe6/gi
		s/%e7/\xe7/gi
		s/%e8/\xe8/gi
		s/%e9/\xe9/gi
		s/%ea/\xea/gi
		s/%eb/\xeb/gi
		s/%ec/\xec/gi
		s/%ed/\xed/gi
		s/%ee/\xee/gi
		s/%ef/\xef/gi
		s/%f0/\xf0/gi
		s/%f1/\xf1/gi
		s/%f2/\xf2/gi
		s/%f3/\xf3/gi
		s/%f4/\xf4/gi
		s/%f5/\xf5/gi
		s/%f6/\xf6/gi
		s/%f7/\xf7/gi
		s/%f8/\xf8/gi
		s/%f9/\xf9/gi
		s/%fa/\xfa/gi
		s/%fb/\xfb/gi
		s/%fc/\xfc/gi
		s/%fd/\xfd/gi
		s/%fe/\xfe/gi
		s/%ff/\xff/gi
	')"

if [[ "$UTF_FILENAME" == "" ]]; then
	curl -s "$URL" --compressed -b "$COOKIE_JAR" -O -J
else
	curl -s "$URL" --compressed -b "$COOKIE_JAR" -o "$UTF_FILENAME"
fi
